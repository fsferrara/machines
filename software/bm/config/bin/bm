#!/usr/bin/env bash

# version
BM_NAME=bm
VERSION="1.0.0-fsferrara"
# bookmarks file
BOOKMARKS=~/.bookmarks
touch -a ${BOOKMARKS}

# Output usage info
#

usage() {
  cat << EOF

  Usage: ${BM_NAME} [cmd] ...

  Commands:

    # add a bookmark with the given url and optional tags
    $ ${BM_NAME} add <url> "Bookmark Title" [tag...]

    # list bookmarks available
    $ ${BM_NAME} list
    $ ${BM_NAME} ls
    $ ${BM_NAME}

    # open the first bookmark matching <query>
    $ ${BM_NAME} open <query>

    # copy to the macos clipboard the first bookmark matching <query>
    $ ${BM_NAME} copy <query>

    # search the bookmarks via full-text <query>
    $ ${BM_NAME} search <query>

    # list tags
    $ ${BM_NAME} tags

    # display statistics about the bookmarks
    $ ${BM_NAME} statistics
    $ ${BM_NAME} stats

    $ ${BM_NAME} version   # output ${BM_NAME} version
    $ ${BM_NAME} help      # output this help information

EOF
}

# Add a bookmark
#   <url> [description] [tag ...]

save_bookmark() {
  local url=$1
  local title=$2
  local tags=${@:3}
  echo "  Added bookmark"
  echo "    title: $title"
  echo "    url: $url"
  echo "    tags: $tags"
  echo "$url|$tags|$title" >> $BOOKMARKS
}

# List all bookmarks
#   Removes comments and empty lines

list_bookmarks() {
  echo
  cat $BOOKMARKS \
    | grep -v -e '^#\|^$' \
    | awk '
    BEGIN { FS = "|" }
    {
      printf "[\033[1;33m%s\033[0m]", $3
      printf "(\033[1;32m%s\033[0m) ", $1
      printf "# \033[1;35m%s\033[0m\n", $2
    }'
}

# Filter bookmarks with <query> that may contains multiple words
#   Removes comments and empty lines

filter_bookmarks() {
  local filtered_list=`cat $BOOKMARKS | grep -v -e '^#\|^$'`;
  for item in "$@" ; do
    filtered_list=`echo "$filtered_list" | grep -i $item`;
  done
  echo "$filtered_list";
}

# Search all bookmarks with <query>
#

search_bookmarks() {
  filtered=`filter_bookmarks $@`;
  if [ ! -z "$filtered" ]; then
   echo "$filtered" | awk '
     BEGIN { FS = "|" }
     {
       printf "[\033[1;33m%s\033[0m]", $3
       printf "(\033[1;32m%s\033[0m) ", $1
       printf "# \033[1;35m%s\033[0m\n", $2
     }'
  fi
}

# Open first bookmark matching <query>
#

open_bookmark() {
  filtered=`filter_bookmarks $@`;
  selected=`echo "$filtered" \
    | cut -d '|' -f 1 | head -n 1`;

  if [ ! -z "$selected" ]
  then
    echo "[open] $selected";
    open $selected
  fi
}

# Copy first bookmark matching <query>
# Only works in macos

copy_bookmark() {
  filtered=`filter_bookmarks $@`;
  selected=`echo "$filtered" \
    | cut -d '|' -f 1 | head -n 1`;

  if [ ! -z "$selected" ]
  then
    echo "[pbcopy] $selected";
    echo $selected | pbcopy
  fi
}

# Diplay some statistics about the bookmarks
#

show_statistics() {
  local total_bookmarks=$(cat $BOOKMARKS | wc -l | sed 's/^ *//')
  local total_tags=$(list_tags | wc -l | sed 's/^ *//')
  echo "    total bookmarks: $total_bookmarks"
  echo "         total tags: $total_tags"
  echo "        top 10 tags: `display_top_ten_tags`"
}

# Output tags.
#

list_tags() {
  cat $BOOKMARKS \
    | cut -f2 -d '|' \
    | tr " " "\n" \
    | sort \
    | uniq -c \
    | sort -nr
}

# Display the 10 most frequently used tags
#

display_top_ten_tags() {
  echo
  printf "%20s  %s\n" count tag
  list_tags \
    | head -10 \
    | awk '{ printf("%20d  %s\n", $1, $2) }'
}

# List urls
#

urls() {
  cat $BOOKMARKS \
    | grep "$1" \
    | cut -d '|' -f 1
}

# no args

if test $# -eq 0; then
  list_bookmarks 10
  exit
fi

# parse args

while test $# -ne 0; do
  arg=$1; shift
  case $arg in
    version|-V|--version) echo $VERSION; exit ;;
    help|-h|--help) usage; exit ;;
    tags) list_tags; exit ;;
    ls|list) list_bookmarks "$@"; exit ;;
    search) search_bookmarks "$@"; exit ;;
    open) open_bookmark "$@"; exit ;;
    copy) copy_bookmark "$@"; exit ;;
    add) save_bookmark "$@"; exit ;;
    stats|statistics) show_statistics; exit ;;
    *) list_bookmarks $arg; exit ;;
  esac
done

