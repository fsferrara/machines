#!/usr/bin/env bash
set -e
set -u
set -o pipefail

## Recursively extract all the jars in a folder
#
# Trigger this script in a folder containing one or more JARs files.
# It will unzip all the JARs and, recursively, analyze the `-unzipped` folders
# to extraxt the contet from other JARs that may be included in it.
function analyzeDirectory() {

    # List all the JARs in the current directory
    JAR_LIST=$(ls *.jar 2>/dev/null)

    if [ "x$JAR_LIST" != "x" ]
    then
        for JAR in $JAR_LIST
        do
            if [ -f $JAR ]  # ignore symbolic links
            then	
                echo -e "> [JAR] Extracting ${JAR} into ${JAR}-unzipped ..."
                unzip ${JAR} -d ${JAR}-unzipped
                (
                    # Recursively analyze the content of the unzipped directory
                    cd ${JAR}-unzipped
                    analyzeDirectory
                )
            fi
        done
    fi

    DIR_LIST=$(ls -d * 2>/dev/null)

    for SUB_DIR in $DIR_LIST
    do
        if [ -d $SUB_DIR -a ! -h $SUB_DIR ]  # consider directories not symbolically linked
        then
            # ignore the -unzipped directories since those are already covered
            if [[ $SUB_DIR != *.jar-unzipped ]]
            then
                (
                    cd $SUB_DIR
                    analyzeDirectory
                )
            fi
        fi
    done
}

analyzeDirectory
