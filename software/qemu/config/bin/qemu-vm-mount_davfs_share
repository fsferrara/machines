#!/usr/bin/env bash

VM_SHARE="${HOME}/vm/share"
umount ${VM_SHARE}
mkdir -p ${VM_SHARE}
MY_UID=$(id -u)
MY_GID=$(id -g)
sudo mount -v -t davfs -o dir_mode=0755,file_mode=0644,gid=${MY_UID},uid=${MY_GID} http://localhost:9843 ${VM_SHARE}


# ## Shared Folder 

# QEMU allows to share folders in two different ways: VirtFS or WebDAV.

# VirtFS has a limitation at the moment, I'll go with SPICE WebDAV that is a suboptimal solution.

# ### Spice WebDAV

# UTM guest needs spice-tools:

# ```
# sudo apt-get install -y spice-vdagent spice-webdavd
# ```

# To access shared folder, go to `dav://localhost:9843/`.

# Once installed, it should work out-of-the-box. If it didn't, try to manually start the daemon with: `spice-webdavd -p 9843`.
 
# #### Permanently mount the shared folder

# Install `davfs2` package to mount WebDAV resource as regular file system:

# ```
# sudo apt-get install davfs2
# sudo usermod -a -G davfs2 ${USER}
# ```

# To manually mount:
# ```
# sudo mount -v -t davfs -o dir_mode=0755,file_mode=0644,gid=1000,uid=1000 http://localhost:9843 /mnt/dav
# ```

# Or permanently, add this to the `/etc/fstab/` file:

# ```
# http://localhost:9843 /mnt/share davfs dir_mode=0755,file_mode=0644,gid=1000,uid=1000,users 0 0
# ```

# Optionally, to avoid macos extended attributes on new files, the file quarantine feature needs to be disabled:

# ```
# sudo defaults write com.apple.LaunchServices LSQuarantine -bool NO
# ```
